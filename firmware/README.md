# Прошивка контроллера перемещения

## Описание принципов работы

#### Общие сведения

Контроллер перемещения получает команды от одноплатного компьютера по USB в режиме серийного порта по протоколу ModbusRTU.
Колеса приводятся в движение шаговыми двигателями через понижающий редуктор.
Количество шагов на оборот двигателя задается дип-переключателями на корпусе  драйвера и отражается в прошивке.
Коэффициенты редукторов и диаметры колес хранятся в постоянной памяти контроллера EEPROM и могут изменяться для точной настройки.

#### Режимы перемещения

Целевое перемещение осуществляется в трех режимах:
1. к позиции по команде Modbus, режим `MODE::TRG`;
2. в направлении по команде Modbus, режим `MODE::DRCT`;
3. с пульта, режим `MODE::WRD`.

Получив команду на перемещение к позиции (режим `MODE::TRG`), контроллер переводит расстояние в миллиметрах в угол поворота колеса, затем в угол вала двигателя и количество необходимых шагов. Движение осуществляется в пределах заданных ускорения (торможения) и максимальной скорости.

При команде на перемещение в направлении, контроллер разгоняет двигатели до максимальной скорости в заданных пределах ускорения (торможения), и удерживает скорость пока не будет дана иная команда (для режима `MODE::DRCT`) или иной сигнал (для режима `MODE::WRD`).

Во время выполнения команды перемещения контроллер игнорирует все остальные команды, кроме команд остановки, торможения, смены режима или направления.

При переключении режима любым способом **всегда** выполняется команда экстренной остановки.

#### Ручной режим с пульта

Ручной режим управления с проводного пульта (`MODE::WRD`) включается и отключается аппаратно - переключателем.

При отключении контроллер переходит в тот режим управления, который был до включения ручного режима.

Приоритетность обработки сигналов с пульта:
**Вперед >> Вправо >> Назад >> Влево >> Остановка (нет сигнала)**

#### Обработка аварийного сигнала

При получении аварийного дискретного сигнала контроллер:
- производит экстренную остановку моторов;
- прекращает обработку текущей команды, если она была;
- выставляет статус `STS::EMRGENCY` в регистре статуса `REG_INP::STS`;
- игнорирует поступающие команды в командном регистре `REG_HLD::CMD`;
- продолжает обновлять регистры данных.

При пропадании аварийного сигнала в регистр статуса записывается значение `STS::OK`, обработка команд возобновляется, активный режим при этом не меняется.

## Аппаратная совместимость

Прошивка совместима со контроллерами серии Arduino, имеющими напряжение на DO выходах от 5 В до 24 В. Необходимо не менее **6** свободных DO выходов и **6** свободных DI входов.

Тестировалось на Arduino Mega 2560 rev 1.

## Используемые библиотеки

- [ArduinoModbus](https://github.com/arduino-libraries/ArduinoModbus): Реализация протокола ModbusRTU для Arduino.
- [ArduinoRS485](https://github.com/arduino-libraries/ArduinoRS485): Зависимость для ArduinoModbus.
- [EEManager](https://github.com/GyverLibs/EEManager): Библиотека для работы с постоянной памятью контроллера EEPROM.
- [GyverStepper2](https://github.com/GyverLibs/GyverStepper): Библиотека управления шаговыми моторами.

## Конфигурация перед прошивкой

В файле `src\firmware.ino` в первых строках необходимо установить следующие значения:

- `STEPS_REV` - количество шагов на оборот вала, одинаковое для обоих моторов, в соответствии с дип-переключателями на корпусе драйвера;
- `MOTOR_1_STEP_PIN` - номер пина для подключения сигнала STEP/PULSE - шаг 1го шагового драйвера;
- `MOTOR_1_DIR_PIN` - номер пина для подключения сигнала DIRECTION - направление вращения 1го шагового драйвера;
- `MOTOR_1_EN_PIN` - номер пина для подключения сигнала ENABLE - включение мотора 1го шагового драйвера;
- аналогично `MOTOR_2_STEP_PIN`, `MOTOR_2_DIR_PIN`, `MOTOR_2_EN_PIN` для 2го драйвера;

- `WRD_MODE_SWITCH_PIN` - номер пина переключения режима управления с пульта (`MODE::WRD`);
- `DIR_FORWARD_PIN` - номер пина для направления движения **вперед**;
- `DIR_RIGHT_PIN` - номер пина для направления движения **право** (по часовой стрелке);
- `DIR_BACKWARD_PIN` - номер пина для направления движения **назад**;
- `DIR_LEFT_PIN` - номер пина для направления движения **влево** (против часовой стрелки);
- `EMERGENCY_STOP_PIN` - номер пина для подачи аварийного сигнала.

## Сборка

#### 1. VSCode + PlatformIO
Предпочтительный вариант, в редакторе [VSCode](https://code.visualstudio.com/) с установленным расширением [PlatformIO](https://docs.platformio.org/en/latest/integration/ide/pioide.html):
- открыть вкладку **PIO Home** (значок муравья слева);
- нажать кнопку **Open project**;
- в открывшемся окне выбрать данную папку **firmware**;
- внизу окна нажать значок галочки для компиляции, затем стрелки для загрузки прошивки в контроллер.

Тестировалось в Windows 10 и Linux (Ubuntu 22.04).

#### 2. Arduino IDE
В редакторе [Arduino IDE](https://www.arduino.cc/en/software/):
- в **Tools** -> **Library Manager** установить библиотеки из списка Используемых библиотек;
- открыть файл **src\src.ino**;
- нажать кнопку Verify / Upload.

Тестировалось в Windows 10.

## Описание используемого протокола

В рамках протокола `ModbusRTU` использованы следующие типы данных и значения:
- Coil - дискретный бит, чтение/запись;
- Input register - регистр (16 бит), только чтение;
- Holding register - регистр (16 бит), чтение/запись;
- Discrete input - не используется.

**Текущая версия: 1**

### Coil (`COIL`)

| Имя            | Адрес  | Описание                     |
| -------------- | ------ | ---------------------------- |
| `NEW_CMD` |  `00`  | Признак отправленной команды |
| `NEW_STS` |  `01`  | Признак обновленного статуса выполнения команды |

### Input register (`REG_INP`)

| Имя              | Адрес  | Описание                 |
| ---------------- | ------ | ------------------------ |
| `VER`    |  `00`  | Текущая версия протокола |
| `STS`    |  `01`  | Статус выполнения команды |
| `STPR_L` |  `02`  | Статус *левого* мотора |
| `POS_L`  |  `03`  | Текущая позиция *левого* мотора, в мм |
| `STPR_R` |  `04`  | Статус *правого* мотора |
| `POS_R`  |  `05`  | Текущая позиция *правого* мотора, в мм |

Статус выполнения команды (`STS`) хранимый регистре `REG_INP::STS` может принимать следующие значения:
| Имя               | Код  | Описание                 |
| ----------------- | ---- | ------------------------ |
| `OK`          | `0`  | Команда выполнена |
| `ERR_MOVING`  | `1`  | Команда не может быть выполнена во время движения |
| `ERR_CMD`     | `2`  | Неизвестная команда |
| `ERR_PARAMS`  | `3`  | Ошибка в параметрах (для команды `CMD::UPDATE` ) |
| `ERR_MODE`    | `4`  | Ошибочный режим работы (для команды `CMD::MODE` ) |
| `ERR_DIR`     | `5`  | Ошибочное направление движения в режиме `MODE::DRCT` (значение регистра `REG_HLD::MAN_DIR` ) |
| `EMRGENCY`    | `6`  | Авария. Получен аварийный сигнал. |
| `ERR_UNKNOWN` | `99` | Неизвестная ошибка |

Статус мотора `REG_INP::STPR`_X принимает следующие значения:
- 0 - останов;
- 1 - движение к заданной позиции;
- 3 - движение в заданном направлении;
- 4 - торможение.

### Holding register (`REG_HLD`)

| Код              | Адрес  | Описание               |
| ---------------- | ------ | ---------------------- |
| `CMD`    |  `00`  | Команда для исполнения |
| `TARG_1` |  `01`  | Абсолютная целевая позиция для 1го мотора, в мм |
| `TARG_2` |  `02`  | Абсолютная целевая позиция для 2го мотора, в мм |
| `RATE`   |  `03`  | Частота обновления статусов и позиций моторов, в Гц |
| `SPD_1`  |  `04`  | Максимальная скорость 1го мотора, в мм/сек |
| `ACC_1`  |  `05`  | Максимальное ускорение 1го мотора, в мм/сек2 |
| `GEAR_1` |  `06`  | Коэффициент 1го редуктора |
| `WHL_1`  |  `07`  | Диаметр 1го колеса, в мм |
| `DIR_1`  |  `08`  | Направление вращения 1го мотора (0 или 1) |
| `SPD_2`  |  `09`  | Максимальная скорость 2го мотора, в мм/сек |
| `ACC_2`  |  `10`  | Максимальное ускорение 2го мотора, в мм/сек2 |
| `GEAR_2` |  `11`  | Коэффициент 2го редуктора |
| `WHL_2`  |  `12`  | Диаметр 2го колеса, в мм |
| `DIR_2`  |  `13`  | Направление вращения 2го мотора (0 или 1) |
| `MODE`   |  `14`  | Режим работы |
| `DIR`    |  `15`  | Направление движения |

Команда для исполнения (`CMD`) в `REG_HLD::CMD` может быть следующей:
| Имя          | Код  | Допустима     | Описание                 |
| ------------ | ---- | ------------- | ------------------------ |
| `BRAKE`  | `0`  | Всегда        | Экстренное торможение |
| `STOP`   | `1`  | Всегда        | Плавная остановка |
| `MOVE`   | `2`  | При остановке | Движение в заданную позицию |
| `UPDATE` | `3`  | При остановке | Записать регистры с адресами 04-13 в EEPROM |
| `MODE`   | `4`  | Всегда        | Переключение режима работы (предварительно вызывает `CMD::BRAKE`). |

Регистр режима работы `REG_HLD::MODE` принимает следующие значения (`MODE`):
| Имя         | Код  | Описание                 |
| ----------- | ---- | ------------------------ |
| `TRG`  |   0  | Движение к целевой позиции (режим по умолчанию) |
| `DRCT` |   1  | Движение в целевом направлении |
| `WRD`  |   2  | Движение в целевом направлении с аппартного пульта (включается только аппаратно) |

Направление движения (`DIR`) в направлении через регистр `REG_HLD::MAN_DIR` может быть следующим:
| Имя            | Код  | Описание                 |
| -------------- | ---- | ------------------------ |
| `STOP`     |   0  | Cтоп (по умолчанию, при включении режима направления) |
| `FORWARD`  |   1  | Прямолинейное движение в перед |
| `RIGHT`    |   2  | Поворот на месте на право (по часовой стрелке) |
| `BACKWARD` |   3  | Прямолинейное движение назад |
| `LEFT`     |   4  | Поворот на месте на лево (против часовой стрелки) |

## Диаграмма взаимодействия
![](./platuml/command_execution.ru.svg)