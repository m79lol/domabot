# Прошивка контроллера перемещения

## Принцип работы:

Контроллер перемещения получает команды на перемещение от одноплатного компьютера по USB в режиме серийного порта по протоколу ModbusRTU.
Колеса приводятся в движение шаговыми двигателями через понижающий редуктор.
Количество шагов на оборот двигателя задается дип переключателями на корпусе  драйвера шагового мотора и хардкодится в прошивке. Коэффициент каждого редуктора и диаметр каждого колеса являются хранимыми переменными в постоянной памяти контроллера EEPROM, и могут изменяться для точной настройки.
Получив команду на перемещение контроллер используя эти величины переводит расстояние в миллиметрах в угол поворота колеса, затем угол поворота вала двигателя, а затем в количество необходимых шагов.
Движение осуществляется в пределах заданных ускорения/торможением и максимальной скорости.
Получив команду на движение контроллер игнорирует все прочие команды кроме команд остановки и торможения.

## Аппаратная совместимость

Прошивка должна быть совместима со всеми контроллерами серии Arduino, имеющими напряжение на DO выходах от 5 В (и до 24 В, что подходит для промышленных серий). Необходимо не менее 6 свободных DO выходов.

Тестировалось на Arduino Mega 2560 rev 1.

## Используемые библиотеки

Все используемые библиотеки устанавливаются через Tools -> Library Manager в Arduino IDE.

- [ArduinoModbus](https://github.com/arduino-libraries/ArduinoModbus): Реализация протокола ModbusRTU длф Arduino.
- [ArduinoRS485](https://github.com/arduino-libraries/ArduinoRS485): Зависимость для ArduinoModbus.
- [EEManager](https://github.com/GyverLibs/EEManager): Библиотека для работы с постоянной памятью контроллера EEPROM.
- [GyverStepper2](https://github.com/GyverLibs/GyverStepper): Библиотека управления шаговыми моторами.

## Конфигурация перед прошивкой

В файле `src\firmware.ino` в первых строках следует поправить значения следующих определений:

- `STEPS_REV` - количество шагов на оборот вала, одинаковое для обоих моторов, выставляется дип переключателями на корпусе драйвера шагового двигателя;
- `MOTOR_1_STEP_PIN` - номер пина для подключения сигнала STEP/PULSE - шаг 1го шагового драйвера;
- `MOTOR_1_DIR_PIN` - номер пина для подключения сигнала DIRECTION - направление вращения DIR 1го шагового драйвера;
- `MOTOR_1_EN_PIN` - номер пина для подключения сигнала ENABLE - включение мотора 1го шагового драйвера;
- определения `MOTOR_2_STEP_PIN`, `MOTOR_2_DIR_PIN`, `MOTOR_2_EN_PIN` аналогичны, только для 2го драйвера.

## Описание используемого протокола

В рамках протокола `ModbusRTU` использованы следующие типы данных и значения:
- Coil - дискретный бит, чтение/запись;
- Input register - регистр (16 бит), только чтение;
- Holding register - регистр (16 бит), чтение/запись;
- Discrete input - не используется.

### Coil

| Имя            | Адрес  | Описание                     |
| -------------- | ------ | ---------------------------- |
| `COIL_NEW_CMD` |  `00`  | Признак отправленной команды |
| `COIL_NEW_STS` |  `01`  | Признак обновленного статуса выполнения команды |

### Input register

| Имя              | Адрес  | Описание                 |
| ---------------- | ------ | ------------------------ |
| `REG_INP_VER`    |  `00`  | Текущая версия протокола |
| `REG_INP_STS`    |  `01`  | Статус выполнения команды |
| `REG_INP_STPR_1` |  `02`  | Статус 1го мотора |
| `REG_INP_POS_1`  |  `03`  | Текущая позиция 1го мотора, в мм |
| `REG_INP_STPR_2` |  `04`  | Статус 2го мотора |
| `REG_INP_POS_2`  |  `05`  | Текущая позиция 2го мотора, в мм |

Статус выполнения команды `REG_INP_STS` может принимать следующие значения:
| Имя               | Код  | Описание                 |
| ----------------- | ---- | ------------------------ |
| `STS_OK`          | `0`  | Команда выполнена |
| `STS_ERR_MOVING`  | `1`  | Команда не может быть выполнена во время движения |
| `STS_ERR_CMD`     | `2`  | Неизвестная команда |
| `STS_ERR_PARAMS`  | `3`  | Ошибка в параметрах (для команды `CMD_UPDATE` ) |
| `STS_ERR_UNKNOWN` | `99` | Неизвестная ошибка |

Статус мотора `REG_INP_STPR` принимает следующие значения:
- 0 - стоим;
- 1 - едем;
- 4 - тормозим.

### Holding register

| Код              | Адрес  | Описание               |
| ---------------- | ------ | ---------------------- |
| `REG_HLD_CMD`    |  `00`  | Команда для исполнения |
| `REG_HLD_TARG_1` |  `01`  | Абсолютная целевая позиция для 1го мотора, в мм |
| `REG_HLD_TARG_2` |  `02`  | Абсолютная целевая позиция для 2го мотора, в мм |
| `REG_HLD_RATE`   |  `03`  | Частота обновления статусов и позиций моторов, в Гц |
| `REG_HLD_SPD_1`  |  `04`  | Максимальная скорость 1го мотора, в мм/сек |
| `REG_HLD_ACC_1`  |  `05`  | Максимальное ускорение 1го мотора, в мм/сек2 |
| `REG_HLD_GEAR_1` |  `06`  | Коэффициент 1го редуктора |
| `REG_HLD_WHL_1`  |  `07`  | Диаметр 1го колеса, в мм |
| `REG_HLD_DIR_1`  |  `08`  | Направление вращения 1го мотора (0 или 1) |
| `REG_HLD_SPD_2`  |  `09`  | Максимальная скорость 2го мотора, в мм/сек |
| `REG_HLD_ACC_2`  |  `10`  | Максимальное ускорение 2го мотора, в мм/сек2 |
| `REG_HLD_GEAR_2` |  `11`  | Коэффициент 2го редуктора |
| `REG_HLD_WHL_2`  |  `12`  | Диаметр 2го колеса, в мм |
| `REG_HLD_DIR_2`  |  `13`  | Направление вращения 2го мотора (0 или 1) |

Команда для исполнения в `REG_HLD_CMD` может быть следующей:
| Имя          | Код  | Описание                 |
| ------------ | ---- | ------------------------ |
| `CMD_BRAKE`  | `0`  | Экстренное торможение |
| `CMD_STOP`   | `1`  | Плавная остановка |
| `CMD_MOVE`   | `2`  | Движение в заданную позицию |
| `CMD_UPDATE` | `3`  | Записать регистры с адресами 04-13 в EEPROM |

Команды `CMD_BRAKE` и `CMD_STOP` выполняются в любой момент.

Команды `CMD_MOVE` и `CMD_UPDATE` выполняются только в момент полной остановки.
